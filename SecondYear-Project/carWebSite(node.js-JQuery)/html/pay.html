<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Page</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script>
        $(document).ready(function () {
            const userId = sessionStorage.getItem('userId');

            function getQueryParams() {
                const params = new URLSearchParams(window.location.search);
                const price = params.get('totalPrice');
                return price;
            }

            const totalPrice = getQueryParams();
            document.querySelector("#totalPrice").innerHTML = "$" + totalPrice;

            $('#firstName').on('input', function () {
                // Allow only letters and spaces
                this.value = this.value.replace(/[^a-zA-Z ]/g, '');
            });
            $('#lastName').on('input', function () {
                // Allow only letters and spaces
                this.value = this.value.replace(/[^a-zA-Z ]/g, '');
            });
            $('#cvv').on('input', function () {
                // Remove all non-numeric characters
                this.value = this.value.replace(/\D/g, '').slice(0, 3);
            });
            $('#expiryDate').on('input', function () {
                // Remove all characters except numbers and '/'
                this.value = this.value.replace(/[^0-9\/]/g, '');
                if (this.value.length > 0 && this.value[0] !== '0' && this.value[0] !== '1') {
                    this.value = this.value.slice(1);

                }
                // Validate the month
                const parts = this.value.split('/');
                if (parts[0] && (parts[0] < 1 || parts[0] > 12)) {
                    this.value = '';
                    alert('Invalid month. Please enter a value between 01 and 12.');
                }
                // Validate the date is not in the past
                if (parts.length === 2 && parts[1].length === 2) {
                    const currentDate = new Date();
                    const currentYear = currentDate.getFullYear() % 100; // Get the last two digits of the year
                    const currentMonth = currentDate.getMonth() + 1; // Months are 0-indexed

                    const inputYear = parseInt(parts[1], 10);
                    const inputMonth = parseInt(parts[0], 10);

                    if (
                        inputYear < currentYear ||
                        (inputYear === currentYear && inputMonth < currentMonth)
                    ) {
                        this.value = '';
                        alert('Invalid expiry date. It must be in the future.');
                    }
                }

            });

            $('#cardNumber').on('input', function () {
                // Remove all characters except numbers and spaces
                this.value = this.value.replace(/[^0-9 ]/g, '');
            });
            let cNumber = document.getElementById('cardNumber');
            cNumber.addEventListener('keyup', function (e) {
                let num = cNumber.value;

                let newValue = '';
                num = num.replace(/\s/g, '');
                for (var i = 0; i < num.length; i++) {
                    if (i % 4 == 0 && i > 0) {
                        newValue = newValue.concat(' ');
                    }
                    newValue = newValue.concat(num[i]);
                    cNumber.value = newValue;
                }
            });

            let eDate = document.getElementById('expiryDate');
            eDate.addEventListener('keyup', function (e) {

                let newInput = eDate.value;

                if (e.which != 8) {
                    var numChars = e.target.value.length;
                    if (numChars == 2) {
                        var thisVal = e.target.value;
                        thisVal += '/';
                        e.target.value = thisVal;
                        console.log(thisVal.length);
                    }
                }
            });

            $('#paymentForm').on('submit', function (e) {
                e.preventDefault(); // Prevent the default form submission

                // Get form data
                const firstName = $('#firstName').val().trim();
                const lastName = $('#lastName').val().trim();
                const cardNumber = $('#cardNumber').val().replace(/\s/g, '');  // Remove spaces
                const expiryDate = $('#expiryDate').val();
                const cvv = $('#cvv').val();
                const shippingAddress = $('#shippingAddress').val().trim();

                // Validate form data before sending it
                if (firstName === '' || lastName === '' || cardNumber.length !== 16 || cvv.length !== 3 || expiryDate.length !== 5 || shippingAddress === '') {
                    alert('Please fill out all the required fields.');
                    return;
                }
                const totalPrice = getQueryParams();
                // Prepare data to send to the server
                const paymentData = {
                    userId,
                    totalPrice,
                    shippingAddress
                };

                // Send data using AJAX to your Node.js server
                $.ajax({
                    url: '/process-payment',  // The endpoint on your Node.js server
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(paymentData),  // Convert the object to JSON
                    success: function (response) {
                        // Handle the server response (e.g., show success message)
                        alert('Payment successful!');
                        console.log(response);  // Optionally log the response
                    },
                    error: function (error) {
                        // Handle any errors
                        alert('An error occurred. Please try again.');
                        console.error(error);
                    }
                });
            });



            // Helper function to show error messages
            function showError(selector, message) {
                const inputField = $(selector);
                const errorMessage = `<p class="error-message" style="color: red; font-size: 12px; margin-top: 5px;">${message}</p>`;
                inputField.after(errorMessage);
            }
        });
    </script>
    <style>
        /* General Reset */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        .payment-container {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            width: 400px;
        }

        .payment-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .payment-header h2 {
            font-size: 24px;
            color: #333;
        }

        .total-amount {
            font-size: 20px;
            color: #333;
            margin-top: 5px;
        }

        .total-amount span {
            font-size: 14px;
            color: #777;
        }

        .payment-form {
            display: flex;
            flex-direction: column;
        }


        /* Input container styling */
        .input-container {
            position: relative;
            margin-bottom: 20px;
        }

        .input-container input,
        .input-container textarea {
            width: 100%;
            padding: 10px 10px 10px 0;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 4px;
            outline: none;
            background: none;
            padding-left: 3%;
        }

        /* Placeholder-style behavior for the label */
        .input-container label {
            position: absolute;
            top: 50%;
            left: 3%;
            font-size: 16px;
            color: #999;
            transform: translateY(-50%);
            transition: all 0.3s ease-in-out;
            pointer-events: none;
        }

        /* Move the label when the input is focused or not empty */
        .input-container input:focus+label,
        .input-container textarea:focus+label,
        .input-container input:not(:placeholder-shown)+label,
        .input-container textarea:not(:placeholder-shown)+label {
            top: -10px;
            font-size: 12px;
            color: #007bff;
        }

        /* Optional: Style the input when focused */
        .input-container input:focus,
        .input-container textarea:focus {
            border-color: #007bff;
        }


        /* Styling for the Textarea specifically */
        .input-container textarea {
            resize: vertical;
            /* Allow vertical resize only */
            min-height: 80px;
            /* Ensure text area isn't too small */
        }

        .row {
            display: flex;
            /* Use flexbox for layout */
            justify-content: space-between;
            /* Space out the items */
        }

        .row div {
            flex: 1;
            /* Allow each item to grow */
            margin-right: 10px;
            /* Space between fields */
        }

        .row div:last-child {
            margin-right: 0;
            /* No margin on the last item */
        }

        .payment-icons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .payment-icons img {
            height: 30px;
        }

        .submit-button {
            background-color: #62d8a1;
            color: white;
            padding: 10px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            text-align: center;
            transition: background-color 0.3s ease;
        }

        .submit-button:hover {
            background-color: #4cbf89;
        }

        .submit-button:active {
            transform: scale(0.98);
        }

        .error-message {
            color: red;
            font-size: 12px;
            margin-top: 5px;
            font-weight: 500;
        }
    </style>
</head>

<body>
    <div class="payment-container">
        <div class="payment-header">
            <h2>Total</h2>
            <p class="total-amount" id="totalPrice"> <span>USD</span></p>
        </div>
        <form class="payment-form" id="paymentForm">
            <div class="input-container">
                <input type="text" placeholder=" " id="firstName" required />
                <label for="firstName">First Name</label>
            </div>

            <div class="input-container">
                <input type="text" placeholder=" " id="lastName" required />
                <label for="lastName">Last Name</label>
            </div>

            <div class="input-container">
                <textarea id="shippingAddress" rows="3" autocomplete="address-line1" required></textarea>
                <label for="shippingAddress">Shipping Address</label>
            </div>


            <div class="input-container">
                <input type="text" placeholder=" " id="cardNumber" maxlength="19" required />
                <label for="cardNumber">Card Number</label>
            </div>
            <div class="form-group row">

                <div class="input-container">
                    <input type="text" placeholder=" " id="cvv" maxlength="3" required />
                    <label for="cvv">CVV</label>
                </div>

                <div class="input-container">
                    <input type="text" placeholder=" " id="expiryDate" maxlength="5" required />
                    <label for="expiryDate">MM/YY</label>
                </div>
            </div>

            <div class="payment-icons">
                <img src="https://upload.wikimedia.org/wikipedia/commons/0/04/Mastercard-logo.png" alt="MasterCard">
                <img src="visa-logo-800x450.jpg" alt="Visa">
                <img src="American_Express_logo_(2018).svg (1).webp" alt="American Express">
            </div>
            <button type="submit" class="submit-button">Submit Payment</button>
        </form>
    </div>
</body>

</html>