<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script>
        $(document).ready(function () {

            $.ajax({
                url: '/getOrder',
                method: 'GET',
                success: function (orders) {
                    const rowsHTML = orders.map(order => `
                    <tr>
                        <td>${order.order_id}</td>
                        <td><span class="status ${order.status}">${order.status}</span></td>
                        <td>$${order.total_amount}</td>
                        <td>
                            <button class="viewDetails" id="${order.order_id}">
                                Detail
                            </button>
                        </td>
                    </tr>
                        `).join('');
                    $('#orderTable tbody').html(rowsHTML);
                    console.log(orders);

                },
                error: function (err) {
                    console.error('Error fetching orders:', err);
                }
            });


            $('#orderTable').on('click', '.viewDetails', function () {
                const orderId = $(this).attr('id'); // Get the order ID from the button
                console.log('Fetching details for order:', orderId);

                // Fetch order details from the server
                $.ajax({
                    url: `/get-order-details/${orderId}`,
                    method: 'GET',
                    success: function (order) {
                        console.log('Order Details:', order);

                        // Populate modal with order details
                        const detailsHTML = `
                <p><strong>Order ID:</strong> ${order[0].order_id}</p>
                <p><strong>Delivery Address:</strong> ${order[0].shipping_address || 'N/A'}</p>
                <p><strong>Status:</strong> <span >${order[0].status}</span></p>
                <h3>Order Items</h3>
                <div class="order-items ${order[0].orderId}">
                    ${order.map(
                            item => `
                            <div class="order-item">
                                <img src="${item.product_image}" alt="${item.product_name}" class="product-image">
                                <div>
                                    <p><strong>Product:</strong> ${item.product_name}</p>
                                    <p><strong>Price:</strong> $${item.product_price}</p>
                                    <p><strong>Quantity:</strong> ${item.quantity}</p>
                                    <p><strong>Subtotal:</strong> $${item.subtotal}</p>
                                </div>
                            </div>
                        `
                        )
                                .join('')}
                        
                </div>
            `;
                        $('#orderDetails').html(detailsHTML);
                        if (order[0].status === "Pending") {
                            const buttonAdd = `
                            <button class="confirm-btn" data-order-id="${order[0].order_id}">
                                Confirm -> Processing
                            </button>
                            `;
                            $('.order-items').append(buttonAdd);
                        }

                        $('#orderDetailsModal').fadeIn();
                    },
                    error: function (err) {
                        console.error('Error fetching order details:', err);
                        alert('Failed to fetch order details.');
                    }
                });
            });

            // Close modal on close button click
            $('#orderDetailsModal').on('click', '.confirm-btn', function () {
                const orderId = $(this).data('order-id'); // Retrieve the orderId from the button
                console.log('Confirm button clicked for order:', orderId);

                // Check if the orderId is correctly retrieved
                if (orderId) {
                    // Proceed with the AJAX request to update the order status
                    $.ajax({
                        url: `/update-order-status?orderId=${orderId}&status=Processing`, // Pass parameters as query string
                        method: 'GET',
                        success: function (response) {
                            console.log('Order status updated successfully:', response);
                            $('#orderDetailsModal').fadeOut(); // Close the modal after update
                            location.reload();
                        },
                        error: function (err) {
                            console.error('Error updating order status:', err);
                            alert('Failed to update order status');
                        }
                    });
                } else {
                    console.error('No orderId found!');
                }
            });



            $('.close-button').on('click', function () {
                $('#orderDetailsModal').fadeOut();
            });



        });

    </script>
    <style>
        /* General Reset */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: #f9f9f9;
            color: #333;
            padding: 20px;
        }

        h1 {
            text-align: center;
            margin-bottom: 20px;
            color: #4CAF50;
        }

        /* Table Styling */
        #orderTable {
            width: 100%;
            border-collapse: collapse;
            background-color: #fff;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        #orderTable thead {
            background-color: #4CAF50;
            color: white;
        }

        #orderTable th,
        #orderTable td {
            padding: 15px;
            text-align: center;
            border: 1px solid #ddd;
        }

        #orderTable th {
            font-weight: bold;
            text-transform: uppercase;
            font-size: 14px;
        }

        #orderTable tbody tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        #orderTable tbody tr:hover {
            background-color: #f1f1f1;
        }

        /* Action Button Styling */
        .viewDetails {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 8px 12px;
            font-size: 14px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .viewDetails:hover {
            background-color: #45a049;
        }

        .viewDetails:active {
            transform: scale(0.98);
        }

        /* Responsive Table */
        @media screen and (max-width: 768px) {
            #orderTable thead {
                display: none;
            }

            #orderTable tbody tr {
                display: block;
                margin-bottom: 15px;
            }

            #orderTable tbody td {
                display: block;
                text-align: right;
                padding: 10px;
                position: relative;
            }

            #orderTable tbody td::before {
                content: attr(data-label);
                position: absolute;
                left: 10px;
                text-align: left;
                font-weight: bold;
            }

            .viewDetails {
                display: block;
                width: 100%;
                text-align: center;
            }
        }


        .status {
            padding: 5px 10px;
            border-radius: 4px;
            color: white;
        }

        .status.Pending {
            background-color: orange;
        }

        .status.Processing {
            background-color: blue;
        }

        .status.Completed {
            background-color: green;
        }

        .status.Cancelled {
            background-color: red;
        }

        .modal {
            display: none;
            /* Hidden by default */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            overflow-y: scroll;
        }

        .modal-content {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            width: 60%;
            max-width: 700px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            text-align: left;
            position: relative;
        }

        .close-button {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 18px;
            cursor: pointer;
        }

        .order-items {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 15px;
        }

        .order-item {
            display: flex;
            gap: 15px;
            background: #f9f9f9;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }

        .order-item img.product-image {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 4px;
        }

        .order-item div {
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
    </style>
</head>

<body>

    <h1>Order Management</h1>

    <table id="orderTable">
        <thead>
            <tr>
                <th>Order ID</th>
                <th>Status</th>
                <th>Total Amount</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            <!-- Rows dynamically populated with JavaScript -->
        </tbody>
    </table>
    <div id="orderDetailsModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2>Order Details</h2>
            <div id="orderDetails">
                <!-- Details will be populated dynamically -->
            </div>
        </div>
    </div>
</body>

</html>